name: Deploy to Hostgator (Static Site)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependências
        run: npm ci

      - name: Build do projeto (static export)
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ secrets.NEXT_PUBLIC_BASE_PATH || '' }}

      - name: Instalar dependências para deploy
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Configurar SSH para Hostgator
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOSTGATOR_SSH_HOST }} >> ~/.ssh/known_hosts || true
          echo "Host ${{ secrets.HOSTGATOR_SSH_HOST }}" >> ~/.ssh/config
          echo "  KexAlgorithms +diffie-hellman-group-exchange-sha256" >> ~/.ssh/config
          echo "  HostKeyAlgorithms +ssh-rsa" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy via rsync para Hostgator
        run: |
          sshpass -p '${{ secrets.HOSTGATOR_SSH_PASSWORD }}' rsync -avz --delete \
            -e "ssh -p ${{ secrets.HOSTGATOR_SSH_PORT || 22 }} -o StrictHostKeyChecking=no -o KexAlgorithms=+diffie-hellman-group-exchange-sha256" \
            out/ ${{ secrets.HOSTGATOR_SSH_USERNAME }}@${{ secrets.HOSTGATOR_SSH_HOST }}:${{ secrets.HOSTGATOR_DEPLOY_PATH }}/